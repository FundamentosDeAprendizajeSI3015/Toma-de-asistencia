{% extends 'attendance/base.html' %}

{% block title %}Editar Asistencia - {{ session.date|date:"d/m/Y" }}{% endblock %}

{% block content %}
<div class="attendance-page">
    <div class="page-header">
        <a href="{% url 'attendance:session_detail' session.id %}" class="back-link">‚Üê Volver al detalle</a>
        <div class="date-info">
            <h2 class="page-title">Editar asistencia</h2>
            <p class="current-date">üìÖ {{ session.date|date:"l, d \d\e F \d\e Y" }}</p>
        </div>
        <div class="stats-summary">
            <div class="stat-card present">
                <span class="stat-number" id="presentCount">{{ present_count }}</span>
                <span class="stat-label">Presentes</span>
            </div>
            <div class="stat-card absent">
                <span class="stat-number" id="absentCount">{{ absent_count }}</span>
                <span class="stat-label">Ausentes</span>
            </div>
            <div class="stat-card total">
                <span class="stat-number">{{ total_students }}</span>
                <span class="stat-label">Total</span>
            </div>
        </div>
    </div>

    <div class="actions-bar">
        <div class="bulk-actions">
            <button class="btn btn-secondary" id="selectAll">‚úì Marcar todos</button>
            <button class="btn btn-secondary" id="deselectAll">‚úó Desmarcar todos</button>
        </div>
        <button class="btn btn-primary" id="saveAttendance">
            <span class="btn-text">üíæ Guardar Cambios</span>
            <span class="btn-loading" style="display: none;">Guardando...</span>
        </button>
    </div>

    <div class="students-grid" id="studentsGrid">
        {% for item in students_data %}
        <div class="student-card" data-student-id="{{ item.student.id }}">
            <label class="student-checkbox-label">
                <input type="checkbox" class="student-checkbox" data-student-id="{{ item.student.id }}" {{
                    item.is_present|yesno:"checked," }}>
                <span class="checkbox-custom"></span>
                <div class="student-info">
                    <span class="student-name">{{ item.student.full_name }}</span>
                    {% if item.student.github_username %}
                    <span class="student-github">@{{ item.student.github_username }}</span>
                    {% elif item.student.email %}
                    <span class="student-email">{{ item.student.email }}</span>
                    {% endif %}
                </div>
            </label>
        </div>
        {% endfor %}
    </div>

    <div class="toast" id="toast">
        <span class="toast-message"></span>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const TOTAL_STUDENTS = {{ total_students }};
    const SESSION_ID = {{ session.id }};
    const SAVE_URL = '/session/' + SESSION_ID + '/save/';
</script>
<script>
    // Override save function for edit mode
    document.addEventListener('DOMContentLoaded', function () {
        const saveBtn = document.getElementById('saveAttendance');
        if (saveBtn) {
            saveBtn.addEventListener('click', async function () {
                const btnText = saveBtn.querySelector('.btn-text');
                const btnLoading = saveBtn.querySelector('.btn-loading');

                const checkboxes = document.querySelectorAll('.student-checkbox');
                const attendanceData = {};

                checkboxes.forEach(checkbox => {
                    const studentId = checkbox.getAttribute('data-student-id');
                    attendanceData[studentId] = checkbox.checked;
                });

                btnText.style.display = 'none';
                btnLoading.style.display = 'inline';
                saveBtn.disabled = true;

                try {
                    const response = await fetch(SAVE_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ attendance: attendanceData })
                    });

                    const result = await response.json();

                    if (result.success) {
                        showToast('‚úì ' + result.message, 'success');
                        // Redirect back to detail after short delay
                        setTimeout(() => {
                            window.location.href = '/session/' + SESSION_ID + '/';
                        }, 1500);
                    } else {
                        showToast('Error: ' + (result.error || 'No se pudo guardar'), 'error');
                    }
                } catch (error) {
                    console.error('Error saving attendance:', error);
                    showToast('Error al guardar la asistencia', 'error');
                } finally {
                    btnText.style.display = 'inline';
                    btnLoading.style.display = 'none';
                    saveBtn.disabled = false;
                }
            });
        }
    });
</script>
{% endblock %}