{% extends 'attendance/base.html' %}

{% block title %}{{ student.full_name }}{% endblock %}

{% block content %}
<div class="student-detail-page">
    <div class="page-header">
        <a href="{% url 'attendance:students_list' %}" class="back-link">‚Üê Volver a estudiantes</a>
        <h2 class="page-title">{{ student.full_name }}</h2>
    </div>

    <div class="student-info-section">
        <div class="info-card">
            <div class="card-header-actions"
                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3 class="section-subtitle" style="margin-bottom: 0;">üìß Informaci√≥n de contacto</h3>
                <button class="btn btn-sm btn-primary" id="saveProfileBtn">
                    <span class="btn-text">üíæ Guardar</span>
                    <span class="btn-loading" style="display: none;">Guardando...</span>
                </button>
            </div>
            <div class="info-grid">
                <div class="info-item">
                    <label for="studentEmail" class="info-label"
                        style="display: block; margin-bottom: 0.5rem;">Email</label>
                    <input type="email" id="studentEmail" class="form-input"
                        value="{{ student.email|default_if_none:'' }}" placeholder="ejemplo@eafit.edu.co"
                        style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); background: var(--bg-primary); color: var(--text-primary); border-radius: 4px;">
                </div>
                <div class="info-item">
                    <label for="studentGithub" class="info-label"
                        style="display: block; margin-bottom: 0.5rem;">GitHub</label>
                    <div class="input-group" style="display: flex; gap: 0.5rem; align-items: center;">
                        <span class="input-prefix" style="color: var(--text-muted);">@</span>
                        <input type="text" id="studentGithub" class="form-input"
                            value="{{ student.github_username|default_if_none:'' }}" placeholder="usuario"
                            style="flex: 1; padding: 0.5rem; border: 1px solid var(--border-color); background: var(--bg-primary); color: var(--text-primary); border-radius: 4px;">
                    </div>
                    {% if student.github_username %}
                    <a href="https://github.com/{{ student.github_username }}" target="_blank" class="github-link-small"
                        id="githubLinkPreview"
                        style="display: inline-block; margin-top: 0.5rem; font-size: 0.85rem; color: var(--primary-color);">
                        Ver perfil <span class="external-icon">‚Üó</span>
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="stats-card">
            <h3 class="section-subtitle">üìä Estad√≠sticas</h3>
            <div class="stats-grid">
                <div class="stat-item">
                    <span class="stat-value success">{{ attendance_count }}</span>
                    <span class="stat-label">Asistencias</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value danger">{{ absence_count }}</span>
                    <span class="stat-label">Faltas</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value primary">{{ attendance_percentage }}%</span>
                    <span class="stat-label">Asistencia</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value primary">{{ competencies_achieved }}/{{ total_competencies }}</span>
                    <span class="stat-label">Competencias</span>
                </div>
            </div>
        </div>
    </div>

    <div class="competencies-section">
        <div class="section-header">
            <h3 class="section-subtitle">üéØ Competencias</h3>
            <button class="btn btn-primary" id="saveCompetencies">
                <span class="btn-text">üíæ Guardar cambios</span>
                <span class="btn-loading" style="display: none;">Guardando...</span>
            </button>
        </div>

        <div class="competencies-grid">
            {% for item in competencies_data %}
            <div class="competency-card">
                <label class="competency-checkbox-label">
                    <input type="checkbox" class="competency-checkbox" {% if item.is_achieved %}checked{% endif %}
                        data-competency-id="{{ item.competency.id }}">
                    <span class="checkbox-custom"></span>
                    <div class="competency-info">
                        <span class="competency-name">{{ item.competency.name }}</span>
                        <span class="competency-description">{{ item.competency.description }}</span>
                    </div>
                </label>
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="toast" id="toast">
        <span class="toast-message"></span>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const STUDENT_ID = {{ student.id }};
    const SAVE_COMPETENCIES_URL = '/student/' + STUDENT_ID + '/competencies/save/';
    const UPDATE_PROFILE_URL = '/student/' + STUDENT_ID + '/update/';

    function showToast(message, type = 'success') {
        const toast = document.getElementById('toast');
        const toastMessage = toast.querySelector('.toast-message');

        toastMessage.textContent = message;
        toast.className = 'toast show ' + type;

        // Colores y iconos seg√∫n tipo
        if (type === 'success') toast.style.backgroundColor = 'var(--success-color)';
        if (type === 'error') toast.style.backgroundColor = 'var(--danger-color)';

        setTimeout(() => {
            toast.className = 'toast';
        }, 3000);
    }

    document.addEventListener('DOMContentLoaded', function () {
        // --- Guardar Competencias ---
        const saveCompetenciesBtn = document.getElementById('saveCompetencies');
        if (saveCompetenciesBtn) {
            saveCompetenciesBtn.addEventListener('click', async function () {
                const btnText = saveCompetenciesBtn.querySelector('.btn-text');
                const btnLoading = saveCompetenciesBtn.querySelector('.btn-loading');

                const checkboxes = document.querySelectorAll('.competency-checkbox');
                const competenciesData = {};

                checkboxes.forEach(checkbox => {
                    const competencyId = checkbox.getAttribute('data-competency-id');
                    competenciesData[competencyId] = checkbox.checked;
                });

                btnText.style.display = 'none';
                btnLoading.style.display = 'inline';
                saveCompetenciesBtn.disabled = true;

                try {
                    const response = await fetch(SAVE_COMPETENCIES_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ competencies: competenciesData })
                    });

                    const result = await response.json();

                    if (result.success) {
                        showToast('‚úì Competencias guardadas', 'success');
                    } else {
                        showToast('Error: ' + (result.error || 'No se pudo guardar'), 'error');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    showToast('Error al guardar', 'error');
                } finally {
                    btnText.style.display = 'inline';
                    btnLoading.style.display = 'none';
                    saveCompetenciesBtn.disabled = false;
                }
            });
        }

        // --- Guardar Perfil (Email/Github) ---
        const saveProfileBtn = document.getElementById('saveProfileBtn');
        if (saveProfileBtn) {
            saveProfileBtn.addEventListener('click', async function () {
                const btnText = saveProfileBtn.querySelector('.btn-text');
                const btnLoading = saveProfileBtn.querySelector('.btn-loading');

                const email = document.getElementById('studentEmail').value;
                const github = document.getElementById('studentGithub').value;

                btnText.style.display = 'none';
                btnLoading.style.display = 'inline';
                saveProfileBtn.disabled = true;

                try {
                    const response = await fetch(UPDATE_PROFILE_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            email: email,
                            github_username: github
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        showToast('‚úì Perfil actualizado', 'success');
                        // Actualizar enlace de preview si existe/cambia
                        const previewLink = document.getElementById('githubLinkPreview');
                        if (result.github_username) {
                            if (previewLink) {
                                previewLink.href = 'https://github.com/' + result.github_username;
                                previewLink.innerHTML = 'Ver perfil <span class="external-icon">‚Üó</span>';
                            } else {
                                // Crear si no existe (opcional, o recargar)
                                // Por simplicidad, recargar la p√°gina es una opci√≥n, pero ya que es AJAX mejor no.
                            }
                        }
                    } else {
                        showToast('Error: ' + (result.error || 'No se pudo guardar'), 'error');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    showToast('Error al guardar', 'error');
                } finally {
                    btnText.style.display = 'inline';
                    btnLoading.style.display = 'none';
                    saveProfileBtn.disabled = false;
                }
            });
        }
    });
</script>
{% endblock %}